# **智能网页文档助手（Smart Page Scribe）详细功能规格文档**

**版本：** 2.1
**状态：** 细化定稿
**日期：** 2025年1月18日

## **F1: 账户与配置模块**

| 功能ID | 功能名称 | 详细描述 | 输入 | 处理逻辑 | 输出 | 优先级 | 验收标准 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **F1.1** | **API配置界面** | 提供图形化界面供用户输入和管理其大模型API凭证。 | 1. 用户点击插件图标后选择“设置”。<br>2. 用户输入的API Key、Base URL（可选）。 | 1. 以表单形式展示输入字段。<br>2. 对输入的API Key进行基础格式校验（非空、特定前缀）。<br>3. 将凭证临时缓存在内存中，待测试或保存。 | 1. 一个包含“API Key”、“Base URL”输入框及“测试连接”、“保存”按钮的设置页面。<br>2. 格式错误的即时提示。 | P0 | 用户可成功打开设置页并输入信息。 |
| **F1.2** | **安全存储与加密** | 将用户API凭证安全地保存在本地浏览器中。 | 通过F1.1界面提交的、已验证的API凭证。 | 1. 使用浏览器提供的 `chrome.storage.local` API存储。<br>2. 在存储前，使用简单的混淆或浏览器环境内可用的加密库对API Key进行加密。<br>3. 存储后清空内存中的临时缓存。 | 1. 凭证被持久化保存。<br>2. 下次打开设置页时，输入框内显示已保存的（脱敏）信息。 | P0 | 关闭浏览器再打开后，设置信息依然存在且有效。 |
| **F1.3** | **连接与功能测试** | 验证用户提供的API凭证是否有效，以及插件核心AI功能是否可用。 | 用户点击“测试连接”按钮。 | 1. 使用已填写的API Key和Base URL，构造一个最小、低成本的请求（例如，发送一个简单的系统消息）。<br>2. 监听请求响应。如果HTTP状态码为200且返回有效JSON，则视为成功；否则视为失败。 | 1. 明确的成功提示：“连接成功！”<br>2. 明确的失败提示：“连接失败，请检查API Key和网络。”并附可能的原因。 | P1 | 用户能明确得知其配置是否可用。 |
| **F1.4** | **智能描述开关** | 允许用户启用或禁用“AI智能推测描述”功能。 | 用户在设置页面点击一个复选框。 | 1. 在设置页面提供一个名为“启用智能任务描述推测”的复选框。<br>2. 将其布尔值状态与API凭证一同保存。 | 1. 开关状态被保存。<br>2. 后续录制流程将根据此状态决定是否触发阶段一AI。 | P1 | 开关状态生效，能正确影响后续功能流。 |

---

## **F2: 智能录制引擎模块**

| 功能ID | 功能名称 | 详细描述 | 输入 | 处理逻辑 | 输出 | 优先级 | 验收标准 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **F2.1** | **录制状态管理** | 管理插件的全局录制状态（未开始、录制中、已停止）。 | 用户点击工具栏按钮的“开始/停止录制”。 | 1. 维护一个全局状态变量。<br>2. 开始录制：状态变为“录制中”，初始化数据收集器。<br>3. 停止录制：状态变为“已停止”，冻结数据收集器，打包数据。 | 1. 工具栏图标视觉变化（如变红）。<br>2. 弹出面板文字更新。<br>3. 触发后续流程（如打开描述选择器）。 | P0 | 用户能通过UI清晰感知当前状态，状态转换正确。 |
| **F2.2** | **点击事件监听与记录** | 捕获用户在页面上所有的鼠标点击操作。 | 用户在处于“录制中”的页面内的任何鼠标点击事件。 | 1. 通过Content Script注入全局点击事件监听器。<br>2. 当事件触发时，收集：时间戳、事件类型（‘click’）、目标元素的XPath/CSS选择器、元素文本（如有）。<br>3. 将此记录发送给Background。 | 一个结构化的点击事件对象，被添加到当前录制会话的`steps`数组中。 | P0 | 在普通网页上，用户每次点击都能被准确记录。 |
| **F2.3** | **页面跳转检测** | 捕获单页应用（SPA）内的路由跳转或传统页面的重新加载。 | 页面的URL哈希变化或通过History API进行的导航。 | 1. 监听 `window.onhashchange` 和 `popstate` 事件。<br>2. 监听 `window.onbeforeunload` 以捕获完整页面重载。<br>3. 记录跳转前后的URL和页面标题。 | 一个类型为 `navigate` 的步骤被添加到`steps`数组中，包含跳转信息。 | P0 | 在主流SPA（如Vue Router, React Router）中，页面视图切换能被记录为一个步骤。 |
| **F2.4** | **自动截图** | 在每次记录操作（点击、跳转）后，自动截取当前可视区域的图像。 | Background在收到一个操作事件记录后。 | 1. 调用 `chrome.tabs.captureVisibleTab(null, {format: 'png', quality: 85})`。<br>2. 将返回的`data:image/png;base64,...`字符串与上一步记录的操作事件关联。 | 一个Base64格式的PNG图像字符串，作为`screenshot`属性附加到对应的`step`对象上。 | P0 | 每个被记录的操作步骤都有一张对应的、可显示的截图。 |
| **F2.5** | **会话数据打包** | 将一次录制过程中产生的所有数据整理成一个结构化的会话对象。 | 用户停止录制时触发的指令。 | 1. 汇总所有`steps`。<br>2. 附加会话元数据：`sessionId`、`startTime`、`endTime`、`pageTitle`、`pageUrl`。<br>3. 将此完整对象存储在临时内存区域，并准备发送给下一流程。 | 一个符合预定结构的 `recordingSession` JSON对象。 | P0 | 对象包含所有步骤、截图和元数据，可供AI处理。 |

---

## **F3: AI智能协作中心模块（核心）**

| 功能ID | 功能名称 | 详细描述 | 输入 | 处理逻辑 | 输出 | 优先级 | 验收标准 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **F3.1** | **阶段一：意图推测触发** | 在录制停止后，自动发起对用户操作意图的分析。 | 从F2.5接收到的完整`recordingSession`对象，且用户未关闭“智能描述”功能。 | 1. 从会话对象中提取关键信息：页面标题、总步骤数、第一步和最后一步的概要（如点击了什么按钮）。<br>2. 使用**专用Prompt模板A**构造请求。<br>3. 调用用户配置的AI API，发送请求。 | 向AI服务发起一次HTTP POST请求，请求体包含优化后的Prompt和上下文。 | P0 | 录制停止后2秒内，请求被正确发出。 |
| **F3.2** | **Prompt模板A (意图推测)** | 用于指导AI生成任务描述的专用指令模板。 | 精炼的操作上下文（见F3.1输入）。 | **模板内容：**<br>“你是一个用户意图分析助手。根据以下用户在网页上的操作序列，推测其最可能想要记录的文档任务。操作总结：用户在页面【{页面标题}】上，进行了 {N} 步操作。第一步是【{第一步摘要}】，最后一步是【{最后一步摘要}】。请生成1到3个最可能、最简洁的任务描述，每个描述应像一个文章标题或具体指令，例如‘生成XX功能的配置教程’、‘记录YY数据的查询过程’。直接以清晰的列表形式返回，不要额外解释。” | 一段格式化好的文本字符串，作为请求的`messages`参数之一。 | P0 | AI能基于此Prompt返回格式规整的描述列表。 |
| **F3.3** | **阶段一结果解析与呈现** | 接收AI返回的推测描述，并格式化成用户可选选项。 | AI API返回的文本响应。 | 1. 解析响应文本，按行或列表项提取出1-3个描述句子。<br>2. 若解析失败或超时，则生成一个默认选项：“生成本次操作指南”。<br>3. 将选项列表传递给UI模块（F4.2）。 | 一个字符串数组，如 `[“创建登录功能教程”， “记录表单提交流程”]`，用于渲染选择器界面。 | P0 | 用户能在界面上看到清晰、可点击的描述选项。 |
| **F3.4** | **阶段二：文档生成触发** | 根据用户最终确认的任务描述，生成完整的文档草稿。 | 1. 用户从F3.3的选项中选择或手动输入的**最终描述**。<br>2. 完整的`recordingSession`对象。 | 1. 使用**专用Prompt模板B**，将最终描述和详细的步骤列表（含截图索引）整合。<br>2. 调用用户配置的AI API，发送请求。 | 向AI服务发起第二次HTTP POST请求，请求体包含文档生成指令和完整上下文。 | P0 | 用户点击“生成”后，请求被正确发出。 |
| **F3.5** | **Prompt模板B (文档生成)** | 用于指导AI生成结构化文档的专用指令模板。 | 最终描述 + 详细步骤列表。 | **模板内容：**<br>“你是一个专业的文档工程师。请根据以下用户操作序列和任务描述，生成一份详细的步骤指南。<br>## 任务描述<br>{用户确认的最终描述}<br>## 操作环境<br>页面：{页面标题} ({页面URL})<br>## 详细操作步骤<br>{按JSON格式列出步骤，每步包含动作、目标和截图索引}<br>## 生成要求<br>1. 使用清晰中文撰写，格式为Markdown。<br>2. 为每个关键步骤创建二级标题（如‘步骤一：点击登录按钮’）。<br>3. 在每一步中，用括号注明操作细节（例如：`（点击了左上角的“登录”按钮）`）。<br>4. 在文档末尾添加‘注意事项’章节。” | 一段整合了所有信息的、结构化的Prompt字符串。 | P0 | AI能基于此Prompt返回一份结构良好、图文对应的Markdown文档。 |
| **F3.6** | **错误处理与降级** | 处理AI调用过程中的网络错误、API错误或内容生成错误。 | 网络异常、API返回非200状态码、AI返回无意义内容。 | 1. **网络/API错误**：在UI显示“生成失败，请检查网络和API配置”，并提供重试按钮。<br>2. **内容错误**：如果返回内容明显不符合Markdown或过于简短，则视为降级，仍将内容展示给用户，但提示“生成内容可能不完整，请手动编辑”。 | 清晰的错误提示信息，或降级后的内容展示。 | P1 | 在各类异常情况下，用户不会遇到空白页或崩溃，而是得到友好指引。 |

---

## **F4: 用户界面与交互模块**

| 功能ID | 功能名称 | 详细描述 | 输入 | 处理逻辑 | 输出 | 优先级 | 验收标准 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **F4.1** | **工具栏图标与弹出面板** | 提供录制的主要控制入口和状态反馈。 | 用户点击浏览器工具栏上的插件图标。 | 1. 根据全局录制状态（F2.1），动态改变图标颜色和弹出面板内容。<br>2. **状态1-未录制**：显示“开始录制”按钮。<br>3. **状态2-录制中**：显示“🔴 正在录制 (X步)”和“停止录制”按钮。<br>4. **状态3-已停止**：显示“录制已停止”和“打开编辑器”按钮。 | 一个与状态对应的小型弹出窗口（Popup）。 | P0 | 图标和面板能实时、正确地反映当前状态。 |
| **F4.2** | **描述选择器界面** | 展示AI推测的任务描述，供用户选择、确认或手动输入。 | 从F3.3接收到的描述选项数组。 | 1. 在侧边栏（Side Panel）或较大弹窗中展示。<br>2. 标题：“智能推测您可能想生成的文档：”。<br>3. 以单选按钮列表形式展示AI选项。<br>4. 最后一个选项是“其他…”，选择后显示一个文本输入框。<br>5. 底部有“生成文档”按钮。 | 一个直观的选择界面，引导用户确认任务意图。 | P0 | 用户能顺利选择一项描述或输入自己的描述，并点击生成。 |
| **F4.3** | **Markdown预览编辑器** | 渲染AI生成的Markdown文档，并提供基础的编辑功能。 | 从F3.5文档生成AI接收到的Markdown文本。 | 1. 使用一个轻量级Markdown渲染库（如Marked.js）将文本转换为HTML并渲染。<br>2. 提供纯文本编辑模式切换按钮。<br>3. 在编辑模式下，允许用户直接修改Markdown源码。<br>4. 提供“复制全文”按钮，一键复制渲染后的HTML或原始Markdown到剪贴板。 | 一个可预览、可编辑的文档界面，包含操作按钮。 | P0 | 文档美观渲染，编辑功能正常，复制功能有效。 |
| **F4.4** | **全局状态提示** | 在非模态情况下向用户提示插件的关键状态，如“正在分析操作…”、“AI生成中…”。 | 后台服务的状态变更（如开始AI分析、AI生成完成）。 | 使用浏览器的 `chrome.notifications` API 或一个固定在页面角落的轻量级Toast组件，显示短暂的、非阻塞性的提示信息。 | 不影响用户操作的文字提示，持续2-3秒后自动消失。 | P2 | 在AI处理等等待期间，用户能得到明确的进度反馈。 |

---
