<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>APIè¿æ¥æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .success { background: #d4edda; border-color: #c3e6cb; }
    .error { background: #f8d7da; border-color: #f5c6cb; }
    .warning { background: #fff3cd; border-color: #ffeaa7; }
    input {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover { background: #5568d3; }
    #result {
      white-space: pre-wrap;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ APIè¿æ¥æµ‹è¯•å·¥å…·</h1>

  <div class="section">
    <h2>æ­¥éª¤1ï¼šåŠ è½½APIé…ç½®</h2>
    <button onclick="loadConfig()">ğŸ“¥ ä»æ’ä»¶åŠ è½½é…ç½®</button>
    <div id="config-display"></div>
  </div>

  <div class="section">
    <h2>æ­¥éª¤2ï¼šæ‰‹åŠ¨è¾“å…¥é…ç½®</h2>
    <label>API Key:</label>
    <input type="password" id="api-key" placeholder="sk-xxxxxxxxxxxxx">

    <label>Base URL:</label>
    <input type="text" id="base-url" placeholder="https://api.deepseek.com">

    <label>æ¨¡å‹åç§°:</label>
    <input type="text" id="model-name" placeholder="deepseek-chat">
  </div>

  <div class="section">
    <h2>æ­¥éª¤3ï¼šæµ‹è¯•è¿æ¥</h2>
    <button onclick="testConnection()">ğŸ” æµ‹è¯•APIè¿æ¥</button>
    <button onclick="stopTest()">â¹ åœæ­¢æµ‹è¯•</button>
    <div id="result"></div>
  </div>

  <div class="section warning">
    <h3>ğŸ’¡ å¸¸è§é…ç½®</h3>
    <button onclick="setDeepSeek()">DeepSeek</button>
    <button onclick="setOpenAI()">OpenAI</button>
  </div>

  <script>
    let currentController = null;

    // åŠ è½½æ’ä»¶é…ç½®
    async function loadConfig() {
      try {
        const result = await chrome.storage.local.get(['apiKey', 'baseUrl', 'modelName']);
        document.getElementById('api-key').value = result.apiKey || '';
        document.getElementById('base-url').value = result.baseUrl || '';
        document.getElementById('model-name').value = result.modelName || '';

        const display = document.getElementById('config-display');
        if (result.apiKey) {
          display.innerHTML = '<p class="success">âœ… é…ç½®å·²åŠ è½½</p>';
          display.innerHTML += '<p>API Key: ' + maskKey(result.apiKey) + '</p>';
          display.innerHTML += '<p>Base URL: ' + (result.baseUrl || 'æœªé…ç½®') + '</p>';
          display.innerHTML += '<p>æ¨¡å‹: ' + (result.modelName || 'æœªé…ç½®') + '</p>';
        } else {
          display.innerHTML = '<p class="warning">âš ï¸ æœªæ‰¾åˆ°APIé…ç½®</p>';
        }
      } catch (error) {
        document.getElementById('config-display').innerHTML =
          '<p class="error">âŒ åŠ è½½å¤±è´¥: ' + error.message + '</p>';
      }
    }

    function maskKey(key) {
      if (key.length < 10) return key;
      return key.substring(0, 7) + '...' + key.substring(key.length - 4);
    }

    // æµ‹è¯•è¿æ¥
    async function testConnection() {
      const apiKey = document.getElementById('api-key').value.trim();
      const baseUrl = document.getElementById('base-url').value.trim() || 'https://api.openai.com/v1';
      const modelName = document.getElementById('model-name').value.trim() || 'gpt-3.5-turbo';

      if (!apiKey) {
        showResult('âŒ è¯·å…ˆè¾“å…¥API Key', 'error');
        return;
      }

      // æ¸…ç†URL
      let url = baseUrl;
      if (url.endsWith('/')) {
        url = url.slice(0, -1);
      }

      showResult('â³ æ­£åœ¨æµ‹è¯•è¿æ¥...', 'warning');

      // åˆ›å»ºAbortControllerç”¨äºè¶…æ—¶
      currentController = new AbortController();
      const timeoutId = setTimeout(() => {
        if (currentController) {
          currentController.abort();
        }
      }, 15000); // 15ç§’è¶…æ—¶

      const startTime = Date.now();

      try {
        const testUrl = `${url}/chat/completions`;

        const response = await fetch(testUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: modelName,
            messages: [
              { role: 'user', content: 'Hi' }
            ],
            max_tokens: 5
          }),
          signal: currentController.signal
        });

        clearTimeout(timeoutId);
        const elapsed = Date.now() - startTime;

        if (response.ok) {
          const data = await response.json();
          showResult(`âœ… è¿æ¥æˆåŠŸï¼\n\nå“åº”æ—¶é—´: ${elapsed}ms\nçŠ¶æ€ç : ${response.status}\næ¨¡å‹: ${modelName}\n\nè¿”å›æ•°æ®:\n${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          const errorData = await response.json().catch(() => ({ error: 'æ— æ³•è§£æé”™è¯¯å“åº”' }));
          showResult(`âŒ APIé”™è¯¯\n\nçŠ¶æ€ç : ${response.status}\nçŠ¶æ€: ${response.statusText}\n\né”™è¯¯è¯¦æƒ…:\n${JSON.stringify(errorData, null, 2)}`, 'error');
        }
      } catch (error) {
        clearTimeout(timeoutId);

        if (error.name === 'AbortError') {
          showResult(`âŒ è¯·æ±‚è¶…æ—¶ï¼ˆ15ç§’ï¼‰\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. APIåœ°å€ä¸æ­£ç¡®\n3. æœåŠ¡å™¨å“åº”å¤ªæ…¢\n\nå»ºè®®ï¼š\n- æ£€æŸ¥ç½‘ç»œè¿æ¥\n- éªŒè¯Base URLæ˜¯å¦æ­£ç¡®\n- å°è¯•ä½¿ç”¨ä¸åŒçš„APIæœåŠ¡`, 'error');
        } else {
          showResult(`âŒ è¯·æ±‚å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ${error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n1. CORSé™åˆ¶\n2. ç½‘ç»œé”™è¯¯\n3. URLæ ¼å¼é”™è¯¯\n\nå»ºè®®æ£€æŸ¥ï¼š\n- Base URLæ ¼å¼æ˜¯å¦æ­£ç¡®\n- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`, 'error');
        }
      } finally {
        currentController = null;
      }
    }

    function stopTest() {
      if (currentController) {
        currentController.abort();
        currentController = null;
        showResult('â¹ æµ‹è¯•å·²åœæ­¢', 'warning');
      }
    }

    function showResult(message, type) {
      const result = document.getElementById('result');
      result.textContent = message;
      result.className = type;
    }

    function setDeepSeek() {
      document.getElementById('base-url').value = 'https://api.deepseek.com';
      document.getElementById('model-name').value = 'deepseek-chat';
    }

    function setOpenAI() {
      document.getElementById('base-url').value = 'https://api.openai.com/v1';
      document.getElementById('model-name').value = 'gpt-3.5-turbo';
    }

    // è‡ªåŠ¨åŠ è½½é…ç½®
    window.addEventListener('DOMContentLoaded', () => {
      loadConfig();
    });
  </script>
</body>
</html>
